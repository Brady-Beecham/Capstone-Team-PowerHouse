* What the software does
    * Each of the two folders has code that is used with ESP32 end devices with RFM95W LoRa radio transceivers. They are meant to be on separate devices because they have different OTAA keys that have been registered to the The Things Stack application.
    * The code runs on FreeRTOS and works with the ESP-IDF. It uses 3 tasks that run concurrently (pulse counter, directional logic, and send message) and one ISR (message received). 
        - The pulse counter task makes use of the PCNT hardware modules of the ESP32 microcontroller to measure the frequency generated by the inductive loop controller PCB. 
        - Directional logic makes judgments on those frequencies to determine which direction a vehicle is traveling and updates the delta accordingly. The delta keeps track of the change in vehicles past the set of loops being monitored by that ESP32. It can be positive or negative. If a car enters the lot, then the delta is incremented. If a car leaves the lot, then the delta is decremented. All the delta values can be gathered up and subtracted from the known value of total spaces in a lot to get the number of available spaces. The delta value is saved to nonvolatile storage to persist in power loss scenarios.
        - Send Message sends the delta at an infrequent set interval to the LoRaWAN gateway.
        - Message Received ISR is triggered from downlinks sent from the gateway. The message should be formatted as a single byte of information representing what you want to set the delta of that end device to. You can send downlinks from the The Things Stack application: https://parking-lot-loops.nam1.cloud.thethings.industries/console/applications/loop-sensor-nodes


* All dependencies
    - ESP-IDF
    - ttn-esp32 Library


* How to Install
   - ESP-IDF: I used the VSCode Extension for ESP-IDF. Using this development framework gives you fine control over your ESP32 hardware. This YouTube video gives an easy-to-follow guide on how to get started with ESP-IDF under VSCode: https://youtu.be/XDDcS7HQNlI?si=Jw7x_gBqWIw9-TFt
    - ttn-esp32 Library: The maintainers of this library have a great getting started guide. Refer to it here: https://github.com/manuelbl/ttn-esp32/wiki/Get-Started However, the folders include the entire ttn-esp32 library as a component so there is no need to install it for these project folders.


* How to run/How to use 
  1. Open the project folder in VSCode. The project folder is the folder named "esp_node_x". The source code will be in the main folder and it is named main.c. You need to open this file in your VSCode window.
  2. Setup. This video can help give a visual: https://youtu.be/XDDcS7HQNlI?si=Jw7x_gBqWIw9-TFt  You need to connect your ESP32 to your PC that has the project open in VSCode. MAKE SURE THE ESP32 IS NOT BEING POWERED FROM A SOURCE ON EITHER THE 5V OR 3.3V PINS BEFORE CONNECTING VIA USB!!! You WILL fry your ESP32 very fast if you do this!! (Speaking from experience...) You will connect your PC to the ESP32 now via USB. Now you need to select the correct COM port to communicate with the ESP32. Look for the plug icon near the bottom left of the screen, use that to open the COM port list. To the right of the plug icon, you need to make sure to set your target to "esp32".
  3. Build, Flash, and Monitor. To compile the code, flash it to the ESP32, and monitor the serial port all in one press of the button, you can press the flame icon. When prompted to select a flash method, choose UART. Compiling could take a long time.
  4. The program should eventually begin to run on your ESP32. If DO_LORAWAN is true then the ESP32 will attempt to make a connection to the LoRaWAN gateway before starting the vehicle detection tasks. If you do not want to connect to the LoRaWAN gateway and only want the vehicle detection functionality, then set DO_LORAWAN to 0 and press the flame icon again to recompile and reflash. 
  5. You should now start seeing the initialization process of the vehicle detection tasks. The ESP32 will get the average frequency of each loop before starting up its other tasks.
  6. After initialization, you will start seeing output from the ESP32 in the serial monitor terminal. You should see messages giving you information like the pulse count, frequency, and time of each sample being taken for each loop. When a vehicle passes over the loops, you will see the frequencies increase, and depending on the direction of travel the delta will be updated. You can change which loop is considered "first" by changing the constant LOOP_A_FIRST to 0 if you want the delta updating to be reversed in direction. That would make a car going over B to A entering when A to B is entering by default.
  7. You will see messages pertaining to LoRaWAN as well. You can see when messages are sent or received.
  8. You can adjust many parameters of the program easily. Such as the timeout period (a form of debouncing), the staleness time, the sample window, the size of the frequency rolling average array, the frequency threshold, and more near the top of the code. I tried to comment it all well enough that you can understand what they all do. Observe how they affect vehicle detection.
