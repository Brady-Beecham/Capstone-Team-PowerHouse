# Loop Controller Subsystem
The purpose of the Loop Controller is to be able to monitor the change in frequency from the inductive loops placed in designated entrances/exits and determine whether a car/pickup truck has passed over the loops.  Once a vehicle is detected, the change in frequency received from the loops will be sent to the ESP32 Microcontroller of the Data Interpretation Subsystem where the count of how many cars/pickup trucks are in the specific parking lot will either increase or decrease, depending on the direction of the car/pickup truck.

# Constraints
| No. | Constraints | Origin |
| --- | ----------- | ------ |
| 1.  | Subsystem shall detect cars/pickup trucks (vehicles) that are entering and exiting a parking lot | System Requirements |
| 2.  | Vehicle detector shall be compliant with the FCC frequency range for Intentional Radiators and verifying the detector is within permissible part 15 frequencies.  | FCC Standard Title 47, Chapter I, Subchapter A, Section 15.202     |
| 3.  | Each entrance/exit of a parking lot shall use a total of one loop controller that will control the two inductive loops at the entrance/exit. | System Requirements |
| 4.  | The Loop Controller shall be connected to the ESP32 Microcontroller that is used with the Data system of the project to communicate a change in voltage, due to change in frequency, in one of the loops and determine whether a vehicle is entering or exiting a parking lot. | System Requirements |

1. For this controller to satisfy the requirements of the project, the Loop Controller must be able to detect changes in frequency that are caused by a vehicle either entering or exiting a parking lot.  Since this Loop Controller is part of a proof of concept, the main focus of the controller is to be able to detect vehicle motion.  With two inductive loops being placed at each designated entrance/exit (found in the Ground Based Sensor Subsystem .md file in this repository), one loop will have a notable change in frequency followed by the second inductive loop experiencing the same change.  By determining the placement of the loops (one being located closer to the road and the other being closer to the parking lot), the direction of the vehicle can be determined and the information will be transmitted to the Data system where the number of available parking spots will either increase or decrease, depending on the direction of the vehicle.

2. For the Loop Controller to work in the United States, it must follow FCC regulations, particularly regulations regarding Intentional Radiators<sup>1</sup>.  Due to the controller having a set frequency around 60 kHz and operating within the range of 10 kHz to 200 kHz, the device does not require a license to operate as it is part of the unlicensed Part 15 bands, mainly used by hobbyists in communication.  With this device being within the permissible Part 15 bands, vehicles will not be affected by the frequency output from the loops that is generated by the Loop Controller.

3. For the Loop Controller to function properly, it must be capable of operating both inductive loops at a designated entrance/exit.  The Loop Controller must be able to detect when a vehicle passes over one of the loops and determine the direction of the vehicle based on which loop experiences a change in frequency first followed by the other loop experiencing a change in frequency.  As an example, in order to monitor the Engineering Quad parking lot (parking lot between the four buildings for the College of Engineering), two sets consisting of two loops each and one detector each will be used to monitor the two designated entrances/exits of the parking lot.

4. Due to the necessary connections to the ESP32 Microcontroller to transmit data received from the loops, the unanimous decision by the team was to make the Loop Controller not be a stand alone device, but instead rely upon the ESP32 to process the output and monitor both the frequency and voltage to detect changes due to vehicles passing over the loops.  With the ESP32 having a programmed capability of a sample rate of 40 MHz, the ESP32 Microcontroller is fully capable receiving the output from the Loop Controller, processing the information for when a change in voltage/frequency occurs, and transmitting the data to the server where the count for the number of available parking spots will be updated for those needing the information.

# Buildable Schematic

![LTSpice Schematic for Loop A](https://github.com/Brady-Beecham/Capstone-Team-PowerHouse/assets/142754780/5d138bcc-e474-4e75-a71d-2b88b8d16f0d)

*LTSpice Schematic for Loop Controller*

![LTSpice Simulation of OscA and Output Non Detailed](https://github.com/Brady-Beecham/Capstone-Team-PowerHouse/assets/142754780/6f1de013-c7e5-46af-81d3-ef709ee27908)

*LTSpice Simulation of Oscillator Output and Square Wave Generator Output*

![Simulation Data for Loop A Frequency](https://github.com/Brady-Beecham/Capstone-Team-PowerHouse/assets/142754780/680dea30-d506-4e66-b441-6f0573bc28e6)

*LTSpice Simulation for Frequency of Oscillator Output*

![Simulation Data for Output A Frequency](https://github.com/Brady-Beecham/Capstone-Team-PowerHouse/assets/142754780/b031f001-4454-4fc3-ac46-8da32272f499)

*LTSpice Simulation for Frequency of Square Wave Output*

![Loop Oscillator Circuit](https://github.com/Brady-Beecham/Capstone-Team-PowerHouse/assets/142754780/951a3950-a235-48a9-8255-9da586504d49)

*Schematic for the Oscillator Circuit*

![Sine to Square Wave Generator](https://github.com/Brady-Beecham/Capstone-Team-PowerHouse/assets/142754780/b2663dc0-3cce-4ef4-aa41-6272c01d68ed)

*Schematic for the Sine to Square Wave Generator Circuit*

![Entire Schematic Diagram](https://github.com/Brady-Beecham/Capstone-Team-PowerHouse/assets/142754780/d7ef5993-2760-4e29-9087-d93e1418dd98)

*Entire Loop Controller Schematic*

![2D PCB Design](https://github.com/Brady-Beecham/Capstone-Team-PowerHouse/assets/142754780/d44f0aca-0efb-4b91-b1ff-935cc8c92754)


*2D PCB View of the Loop Controller*

![3D PCB Design](https://github.com/Brady-Beecham/Capstone-Team-PowerHouse/assets/142754780/7e4755bb-0a85-4025-aaa7-3bb144378d67)

*3D PCB View of the Loop Controller*



# Analysis

## LTSpice Schematic and Entire Loop Controller Schematic


## LTSpice Simulation of Oscillator Output


## LTSpice Simulation of Sine to Square Wave Generator Output

Under the image name of "LTSpice Simulation for Frequency of Oscillator Output", the output of the oscillator circuit is a sinusoidal waveform.  This waveform includes negative voltage values and can damage the ESP32 Microcontroller if this enters the MCU.  To prevent damage happening to the MCU and to also detect when a vehicle passes over the loops, a square wave is needed as the ESP32 only recognizes square waves instead of sinusoidal waves.  By using a Sine Wave to Square Wave generator with a supply voltage of 3.3 VDC (provided by the main 9V power supply that is connected to the L78L33ABZ-AP Voltage Regulator) to allow for a safe maximum voltage to power the circuit and send the information to the ESP32 without causing damage to the pin connections.  Under the image name "LTSpice Schematic for Loop Controller", the Sine to Square Wave Generator begins at C3 after the label "OscA".  Both C3 and R7 components in a series connection reduce the sinusoidal waveform peak-to-peak value and also adjusts the waveform to where every value in the peak-to-peak range is a positive voltage.  Due to this, the waveform can now be adjusted from a positive sinusoidal wave to a square waveform.  By connecting the output from R7 to the negative input of the LT1720 IC chip and using both a 3.3 VDC power supply with an assortment of resistors to control the voltage,  the output from the IC chip is a square waveform that has a range of close to 0 V to a maximum voltage of 3.13 VDC.  This voltage range of the square waveform is well within the safe voltage limits of the ESP32 MCU and can be directly connected to the ESP32 without the risk of damaging any components.






# BOM
| Value                  | Parts                               | Part Number      | Qty | Price per Part | Total Price |
|------------------------|-------------------------------------|------------------|-----|----------------|-------------|
| 220nF                  | C1, C5                              | R82DC3220AA60K   | 1   | $0.30          | $0.30       |
| 100nF                  | C2, C4                              | K104K10X7RF53L2  | 2   | $0.17          | $0.34       |
| 1mF                    | CB-BC, CB-BC1, CB-E, CB-E1, CB-Out, | UVR1H102MHD      | 6   | $0.98          | $5.88       |
|                        | CB-Out1                             |                  |     |                |             |
| 100k                   | RB, RB1                             | MFR-25FTF52-100K | 2   | $0.10          | $0.20       |
| 100                    | RE, RE1, R-Gain, R-Gain1            | MFR-25FTF52-100R | 4   | $0.10          | $0.40       |
| 220                    | RC, RC1                             | CF14JT220R       | 2   | $0.10          | $0.20       |
| 2N3904                 | Q1, Q2                              | 2N3904           | 2   | $0.13          | $0.26       |
| 100mH                  | RFC, RFC1                           | B82731T2301A020  | 1   | $2.72          | $2.72       |
| 10uF                   | C3, C6                              | C322C106K3R5TA   | 2   | $0.79          | $1.58       |
| 33k                    | R7, R14                             | MFR-25FTE52-33K  | 2   | $0.10          | $0.20       |
| 10k                    | R4, R3, R6, R5,R11, R10,R13, R12    | MFR-25FTF52-10K  | 8   | $0.10          | $0.80       |
| 3.3k                   | R2, R9                              | MFR-25FRF52-3K3  | 2   | $0.10          | $0.20       |
| 330k                   | R1, R8                              | MFR-25FTE52-330K | 2   | $0.10          | $0.20       |
| LT1720                 | U1                                  | LT1720CS8#PBF    | 1   | $10.24         | $10.24      |
| 2 Position Connector   | J1                                  | 1711026          | 1   | $2.02          | $2.02       |
| 5 Position Connector   | J2                                  | 1905201          | 1   | $4.55          | $4.55       |
| 3.3V Voltage Regulator | IC1                                 | L78L33ABZ-AP     | 1   | $0.36          | $0.36       |
| Total                  |                                     |                  | 40  |                | $30.45      |


*Note: The prices listed above do not include sales tax or shipping costs.*


# References
1.  “ARRL,” Part 15 - Radio Frequency Devices, http://www.arrl.org/part-15-radio-frequency-devices#Technical (accessed Feb. 14, 2024).
2.  “Chapter 2, Traffic Detector Handbook: Third edition-volume I,” FHWA, https://www.fhwa.dot.gov/publications/research/operations/its/06108/02.cfm (accessed Feb. 14, 2024).
